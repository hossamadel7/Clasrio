@using Microsoft.Extensions.Localization
@using System.Globalization
@inject IStringLocalizerFactory LocalizerFactory
@{
    // Create localizer the same way as Branch view (factory + resource base name)
    var Localizer = LocalizerFactory.Create("Subscription", System.Reflection.Assembly.GetExecutingAssembly().GetName().Name);
    var isArabic = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "ar";
    var htmlLang = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    var htmlDir = isArabic ? "rtl" : "ltr";
    ViewData["Title"] = Localizer["Title"];
    Layout = "_Layout";
}

<!DOCTYPE html>
<html lang="@htmlLang" dir="@htmlDir">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>

    @* Conditional RTL/LTR bootstrap like Branch view *@
    @if (isArabic)
    {
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" />
    }
    else
    {
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    }

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/Subscription.css?v=@DateTime.UtcNow.Ticks" />
</head>
<body>

    <div class="subscription-page">
        <div class="container-fluid py-3">
            <!-- Page Header -->
            <div class="subscription-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="page-title-section">
                        <h3 class="page-title mb-0">
                            <i class="bi bi-card-checklist me-2"></i>
                            @Localizer["Title"]
                        </h3>
                        <p class="page-subtitle text-muted mb-0">@Localizer["Subtitle"]</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success me-2 modern-btn" id="btnRefresh">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span class="btn-text">@Localizer["Refresh"]</span>
                        </button>
                        <button class="btn btn-primary modern-btn" id="btnAddPlan">
                            <i class="bi bi-plus-circle"></i>
                            <span class="btn-text">@Localizer["NewPlan"]</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Alert Messages -->
            <div id="alertHost" class="alert-container"></div>

            <!-- Main Table -->
            <div class="table-card">
                <div class="table-responsive">
                    <table id="plansTable" class="gradient-table w-100">
                        <thead>
                            <tr>
                                <th style="width:60px;">#</th>
                                <th>@Localizer["PlanName"]</th>
                                <th>@Localizer["Price"]</th>
                                <th>@Localizer["TotalCount"]</th>
                                <th>@Localizer["ExpiryMonths"]</th>
                                <th>@Localizer["Description"]</th>
                                <th>@Localizer["SubjectsInPlan"]</th>
                                <th style="width:180px;">@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create / Edit Modal -->
        <div class="modal fade" id="planModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <form id="planForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="planModalTitle">
                                <i class="bi bi-plus-circle me-2"></i>
                                @Localizer["CreateSubscriptionPlan"]
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="SubPlanCode" />

                            <!-- Plan Details -->
                            <div class="form-section">
                                <h6 class="section-title">
                                    <i class="bi bi-info-circle me-2"></i>
                                    @Localizer["PlanInformation"]
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label required">@Localizer["PlanName"]</label>
                                            <input type="text" class="form-control modern-input" id="SubPlanName" placeholder="@Localizer["PlanName"]" required />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="form-label required">@Localizer["Price"]</label>
                                            <input type="number" class="form-control modern-input" id="Price" min="0" placeholder="0" required />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <label class="form-label required">@Localizer["ExpiryMonths"]</label>
                                            <input type="number" step="0.1" class="form-control modern-input" id="ExpiryMonths" min="0" placeholder="0" required />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="form-label">@Localizer["Description"]</label>
                                            <input type="text" class="form-control modern-input" id="Description" placeholder="@Localizer["DescriptionPlaceholder"]" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="section-divider" />

                            <!-- Subjects -->
                            <div class="form-section">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-title mb-0">
                                        <i class="bi bi-book me-2"></i>
                                        @Localizer["SubjectsInPlan"]
                                    </h6>
                                    <button type="button" id="btnAddSubjectRow" class="btn btn-sm btn-outline-primary modern-btn">
                                        <i class="bi bi-plus-circle"></i> @Localizer["AddSubject"]
                                    </button>
                                </div>

                                <div class="subjects-table-container">
                                    <div class="table-responsive">
                                        <table class="table table-bordered subjects-table" id="subjectsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:220px;" class="required">
                                                        <i class="bi bi-calendar me-1"></i>@Localizer["Year"]
                                                    </th>
                                                    <th style="width:260px;" class="required">
                                                        <i class="bi bi-book me-1"></i>@Localizer["Subject"]
                                                    </th>
                                                    <th style="width:140px;" class="required">
                                                        <i class="bi bi-123 me-1"></i>@Localizer["Count"]
                                                    </th>
                                                    <th style="width:80px;">
                                                        <i class="bi bi-trash me-1"></i>@Localizer["Remove"]
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="subjectsTbody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="total-count-section">
                                    <div class="badge bg-info total-count-badge">
                                        <i class="bi bi-calculator me-1"></i>
                                        @Localizer["TotalCount"]: <span id="totalCountDisplay" class="fw-bold">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary modern-btn" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>@Localizer["Close"]
                            </button>
                            <button type="submit" class="btn btn-primary modern-btn" id="btnSavePlan">
                                <i class="bi bi-check-circle me-1"></i>
                                <span class="save-text">@Localizer["SavePlan"]</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            @Localizer["DeleteSubscriptionPlan"]
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center">
                            <div class="delete-icon mb-3">
                                <i class="bi bi-trash3 text-danger" style="font-size: 3rem;"></i>
                            </div>
                            <p class="mb-3 fs-5">@Localizer["DeleteConfirmQuestion"]</p>
                            <p class="text-muted mb-0">@Localizer["DeleteConfirmNote"]</p>
                        </div>
                        <input type="hidden" id="deleteSubPlanCode" />
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button class="btn btn-secondary modern-btn me-2" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>@Localizer["Cancel"]
                        </button>
                        <button class="btn btn-danger modern-btn" id="btnConfirmDelete">
                            <i class="bi bi-trash me-1"></i>
                            <span class="delete-text">@Localizer["DeletePlan"]</span>
                            <span class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buy Plan Modal -->
        <div class="modal fade" id="buyModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <form id="buyForm">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-cart-plus me-2"></i>
                                @Localizer["BuyPlanForStudent"]
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="@Localizer["Close"]"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="buy_SubPlanCode" />

                            <!-- Student Search -->
                            <div class="form-section">
                                <h6 class="section-title">
                                    <i class="bi bi-person-search me-2"></i>
                                    @Localizer["FindStudent"]
                                </h6>
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-7">
                                        <div class="form-group">
                                            <label class="form-label required">@Localizer["StudentPhoneNumber"]</label>
                                            <input type="text" id="studentPhone" class="form-control modern-input"
                                                   placeholder="@Localizer["StudentPhoneNumber"]" required />
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <button type="button" id="btnSearchStudent" class="btn btn-outline-primary w-100 modern-btn">
                                            <i class="bi bi-search me-1"></i> @Localizer["SearchStudent"]
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Search Results -->
                            <div class="form-section">
                                <h6 class="section-title">
                                    <i class="bi bi-list-ul me-2"></i>
                                    @Localizer["SearchResults"]
                                </h6>
                                <div class="search-results-container">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover modern-table" id="studentsResultTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 60px;">
                                                        <i class="bi bi-check-circle"></i>
                                                    </th>
                                                    <th><i class="bi bi-person me-1"></i>@Localizer["StudentName"]</th>
                                                    <th><i class="bi bi-mortarboard me-1"></i>@Localizer["AcademicYear"]</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="no-results">
                                                    <td colspan="3" class="text-center text-muted py-4">
                                                        <i class="bi bi-search me-2"></i>
                                                        @Localizer["SearchForStudentPrompt"]
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <input type="hidden" id="selectedStudentCode" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="plan-info-section me-auto">
                                <span class="badge bg-info plan-info-badge" id="buyPlanInfo">
                                    <i class="bi bi-info-circle me-1"></i>
                                    @Localizer["SelectPlanAndStudent"]
                                </span>
                            </div>
                            <button type="button" class="btn btn-secondary modern-btn me-2" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>@Localizer["Close"]
                            </button>
                            <button type="submit" class="btn btn-success modern-btn" id="btnConfirmBuy" disabled>
                                <i class="bi bi-credit-card me-1"></i>
                                <span class="buy-text">@Localizer["ConfirmPurchase"]</span>
                                <span class="spinner-border spinner-border-sm d-none"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @Html.AntiForgeryToken()

    <!-- Provide localized strings to JS -->
    <script>
        window.SubLoc = {
            None: "@Localizer["None"]",
            LoadingPlans: "@Localizer["LoadingPlans"]",
            NoPlans: "@Localizer["NoPlans"]",
            PlanCreated: "@Localizer["PlanCreated"]",
            PlanUpdated: "@Localizer["PlanUpdated"]",
            PlanDeleted: "@Localizer["PlanDeleted"]",
            PlanDeleteFailed: "@Localizer["PlanDeleteFailed"]",
            OperationFailed: "@Localizer["OperationFailed"]",
            SearchFailed: "@Localizer["SearchFailed"]",
            NoStudentsFound: "@Localizer["NoStudentsFound"]",
            EnterPhoneWarning: "@Localizer["EnterPhoneWarning"]",
            PlanPurchased: "@Localizer["PlanPurchased"]",
            PurchaseFailed: "@Localizer["PurchaseFailed"]",
            ErrorLoadingPlans: "@Localizer["ErrorLoadingPlans"]",
            InvalidSubjectsWarning: "@Localizer["InvalidSubjectsWarning"]",
            PlanNameRequired: "@Localizer["PlanNameRequired"]",
            AtLeastOneSubjectRequired: "@Localizer["AtLeastOneSubjectRequired"]",
            FailedToLoadPlan: "@Localizer["FailedToLoadPlan"]",
            FailedToLoadYears: "@Localizer["FailedToLoadYears"]",
            FailedToLoadSubjects: "@Localizer["FailedToLoadSubjects"]",
            ErrorDeletingPlan: "@Localizer["ErrorDeletingPlan"]",
            ErrorPurchasingPlan: "@Localizer["ErrorPurchasingPlan"]",
            ErrorSavingPlan: "@Localizer["ErrorSavingPlan"]",
            SelectStudent: "@Localizer["SelectStudent"]",
            ErrorSearchingStudents: "@Localizer["ErrorSearchingStudents"]",
            SelectSubject: "@Localizer["SelectSubject"]",
            SelectYear: "@Localizer["SelectYear"]",
            Loading: "@Localizer["Loading"]"
        };
    </script>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="~/js/Subscription.js?v=@DateTime.UtcNow.Ticks"></script>
</body>
</html>