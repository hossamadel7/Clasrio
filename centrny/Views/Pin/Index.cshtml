@model centrny.Controllers.PinController.PinsViewModel
@{
    ViewData["Title"] = "Pins Generator";
}
@section Styles {
    <link rel="stylesheet" href="~/css/Pin.css" asp-append-version="true" />
}

<div class="container-fluid py-3" id="pin-page">
    <div class="row mb-3 align-items-center">
        <div class="col-md-6">
            <h4 class="mb-1 fw-semibold">Pins (Root: @Model.RootCode)</h4>
            <div class="text-muted small d-flex align-items-center gap-2 flex-wrap">
                <span>Wallet Codes Count:</span>
                <span id="walletCodesCount">@Model.WalletCodesCount</span>
            </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0 d-flex gap-2 justify-content-md-end">
            <button id="openGenerateModal" class="btn btn-primary btn-sm" type="button">
                <i class="bi bi-plus-circle me-1"></i> Generate Codes
            </button>
            <button id="refreshPinsBtn" class="btn btn-outline-secondary btn-sm" type="button">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <div id="alertsArea">
        @if (!string.IsNullOrWhiteSpace(Model.Message))
        {
            <div class="alert alert-success py-2">@Model.Message</div>
        }
        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="alert alert-danger py-2">@Model.Error</div>
        }
    </div>

    <div class="card shadow-sm">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Pins List</span>
            <div class="small text-muted">
                Total: <span id="pinTotal">@Model.Pins.Count</span>
            </div>
        </div>
        <div class="table-responsive" style="max-height:65vh; overflow:auto;">
            <table class="table table-sm table-hover table-striped mb-0 align-middle" id="pinsTable">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th style="width:90px;">PinCode</th>
                        <th style="min-width:140px;">Watermark</th>
                        <th style="width:90px;">Type</th>
                        <th style="width:70px;">Times</th>
                        <th style="width:80px;">Status</th>
                        <th style="width:80px;">Active</th>
                        <th style="width:170px;">Insert Time</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Pins.Count == 0)
                    {
                        <tr><td colspan="7" class="text-center text-muted py-4">No pins found.</td></tr>
                    }
                    else
                    {
                        foreach (var p in Model.Pins)
                        {
                            <tr data-pin="@p.PinCode">
                                <td>@p.PinCode</td>
                                <td class="text-truncate" style="max-width:220px;" title="@p.Watermark">@p.Watermark</td>
                                <td>@(p.Type ? "Exam" : "Session")</td>
                                <td>@p.Times</td>
                                <td>@p.Status</td>
                                <td>@(p.IsActive == 1 ? "Yes" : "No")</td>
                                <td>@p.InsertTime.ToString("yyyy-MM-dd HH:mm")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal (custom) -->
<div class="pins-modal-overlay" id="generateModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="pins-modal" role="document">
        <div class="pins-modal-header">
            <h5 class="pins-modal-title">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.4" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                Generate Pins
            </h5>
            <button type="button" class="pins-modal-close" id="closeGenerateModal" aria-label="Close">&times;</button>
        </div>
        <div class="pins-modal-body">
            <form id="generatePinsForm">
                @Html.AntiForgeryToken()
                <div class="pins-form-grid">
                    <div>
                        <label class="form-label">Type</label>
                        <select name="Type" class="form-select" required>
                            <option value="0">Session (0)</option>
                            <option value="1">Exam (1)</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Times</label>
                        <select name="Times" class="form-select" required>
                            <option value="1">1 session</option>
                            <option value="4">4 sessions</option>
                            <option value="16">16 sessions</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Number</label>
                        <input type="number" name="Number" min="1" max="10000" value="1" class="form-control" required />
                    </div>
                </div>
                <div class="pins-modal-footer">
                    <button type="button" class="btn btn-ghost btn-sm" id="cancelGenerateBtn">Cancel</button>
                    <button type="submit" class="btn btn-gradient btn-sm" id="submitGenerateBtn">
                        <span class="btn-text">Generate</span>
                        <span class="spinner-border spinner-border-sm d-none" id="generateSpinner" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
            <small class="text-muted d-block mt-1">
                Note: Times values allowed: 1, 4, 16. Number up to 10,000.
            </small>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/pins.js?v=@DateTime.UtcNow.Ticks"></script>
}