@model centrny.Controllers.ClassDetailViewModel
@{
    ViewData["Title"] = "Live Attendance - " + Model.ClassName;

    // Calculate statistics without lambda expressions
    var totalStudents = Model.Students.Count;
    var attendedStudents = 0;
    var absentStudents = 0;
    foreach (var student in Model.Students)
    {
        if (student.IsAttended)
            attendedStudents++;
        else
            absentStudents++;
    }
    var attendancePercentage = totalStudents > 0 ? (double)attendedStudents / totalStudents * 100 : 0;

    // Sort students manually
    var sortedStudents = new List<centrny.Controllers.ClassStudentViewModel>();
    foreach (var student in Model.Students)
    {
        sortedStudents.Add(student);
    }
    sortedStudents.Sort((x, y) => string.Compare(x.StudentName, y.StudentName, StringComparison.OrdinalIgnoreCase));
}

<!-- Link external stylesheet -->
<link rel="stylesheet" href="~/css/LiveAttendance.css" />

<div class="container-fluid" id="liveAttendanceApp"
     data-class-code="@Model.ClassCode"
     data-scan-url="@Url.Action("ScanQRAttendance", "LiveAttendance")"
     data-students-url="@Url.Action("GetClassStudents", "LiveAttendance")">

    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Live Attendance - @Model.ClassName</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index")">Live Attendance</a></li>
                        <li class="breadcrumb-item active">@Model.ClassName</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Information Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="mdi mdi-book-open text-primary me-2" style="font-size: 1.2rem;"></i>
                                        <div>
                                            <small class="text-muted d-block">Subject</small>
                                            <strong>@Model.SubjectName</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="mdi mdi-account-tie text-primary me-2" style="font-size: 1.2rem;"></i>
                                        <div>
                                            <small class="text-muted d-block">Teacher</small>
                                            <strong>@Model.TeacherName</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="mdi mdi-door text-primary me-2" style="font-size: 1.2rem;"></i>
                                        <div>
                                            <small class="text-muted d-block">Hall</small>
                                            <strong>@Model.HallName</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="mdi mdi-office-building text-primary me-2" style="font-size: 1.2rem;"></i>
                                        <div>
                                            <small class="text-muted d-block">Branch</small>
                                            <strong>@Model.BranchName</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="text-center">
                                <div class="row">
                                    <div class="col-6">
                                        <h3 class="text-info mb-0">@Model.StartTime</h3>
                                        <small class="text-muted">Start Time</small>
                                    </div>
                                    <div class="col-6">
                                        <h3 class="text-warning mb-0">@Model.EndTime</h3>
                                        <small class="text-muted">End Time</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="badge bg-success">
                                        <i class="mdi mdi-calendar me-1"></i>@Model.ClassDate
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Attend Button and Stats -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <button class="btn btn-light btn-lg" id="liveAttendBtn" type="button">
                        <i class="mdi mdi-qrcode-scan me-2"></i>
                        Live Attend - Scan QR Code
                    </button>

                    <!-- NEW: Check/Enable Camera Access button -->
                    <div class="mt-2">
                        <button class="btn btn-outline-light btn-sm" id="checkCameraPermissionBtn" type="button">
                            <i class="mdi mdi-shield-key-outline me-1"></i>
                            Check/Enable Camera Access
                        </button>
                        <span class="badge bg-secondary ms-2" id="cameraPermissionStatus">Unknown</span>
                    </div>

                    <p class="mt-2 mb-0">
                        <small>Click to open camera and scan student QR codes</small>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="text-primary mb-0" id="totalStudents">@totalStudents</h3>
                            <small class="text-muted">Total Enrolled</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-success mb-0" id="attendedStudents">@attendedStudents</h3>
                            <small class="text-muted">Attended</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-danger mb-0" id="absentStudents">@absentStudents</h3>
                            <small class="text-muted">Absent</small>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 8px;">
                        <div class="progress-bar bg-success"
                             role="progressbar"
                             style="width: @attendancePercentage%"
                             id="attendanceProgress"
                             aria-valuenow="@attendancePercentage"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge bg-info" id="attendancePercentage">@Math.Round(attendancePercentage, 1)% Attendance</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="mdi mdi-account-multiple me-2"></i>
                            Enrolled Students
                        </h4>
                        <button class="btn btn-outline-primary btn-sm" id="refreshStudents" type="button">
                            <i class="mdi mdi-refresh me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-centered table-nowrap mb-0" id="studentsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Student Name</th>
                                    <th>Phone</th>
                                    <th>Parent Phone</th>
                                    <th>Branch</th>
                                    <th>Year</th>
                                    <th>Status</th>
                                    <th>Attendance Time</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                @foreach (var student in sortedStudents)
                                {
                                    <tr id="student-@student.StudentCode" class="@(student.IsAttended ? "table-success" : "")">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                @if (student.IsAttended)
                                                {
                                                    <i class="mdi mdi-check-circle text-success me-2"></i>
                                                }
                                                else
                                                {
                                                    <i class="mdi mdi-clock-outline text-muted me-2"></i>
                                                }
                                                <strong>@student.StudentName</strong>
                                            </div>
                                        </td>
                                        <td>@student.StudentPhone</td>
                                        <td>@student.StudentParentPhone</td>
                                        <td>@student.BranchName</td>
                                        <td>@student.YearName</td>
                                        <td>
                                            @if (student.IsAttended)
                                            {
                                                <span class="badge bg-success">Present</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Absent</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="attendance-time">@(student.AttendanceTime ?? "-")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrScannerModalLabel">
                    <i class="mdi mdi-qrcode-scan me-2"></i>Scan Student QR Code
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="qrScannerContainer">
                    <!-- The scanner script expects this div to exist and be empty when modal opens -->
                    <div id="reader"></div>
                    <div class="text-center mt-3">
                        <p class="text-muted">
                            <i class="mdi mdi-information-outline me-1"></i>
                            Position the student's QR code within the scanning area
                        </p>
                        <div id="scanStatus" class="mt-2"></div>
                    </div>

                    <!-- Manual Input Section -->
                    <div class="manual-input-section">
                        <h6 class="text-muted mb-2">
                            <i class="mdi mdi-keyboard me-1"></i>
                            Having trouble scanning? Enter manually:
                        </h6>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="manualItemKey"
                                   placeholder="Enter student item key"
                                   maxlength="50">
                            <button class="btn btn-outline-success" type="button" id="manualAttendBtn">
                                <i class="mdi mdi-check me-1"></i>Mark Present
                            </button>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            You can copy the item key from the student's profile URL
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="mdi mdi-close me-1"></i>Close
                </button>
                <button type="button" class="btn btn-primary" id="switchCamera" style="display: none;">
                    <i class="mdi mdi-camera-switch me-1"></i>Switch Camera
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1200;">
    <div id="attendanceSuccessToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="mdi mdi-check-circle me-2"></i>
            <strong class="me-auto">Attendance Marked</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Load Bootstrap JS first, then your custom scanner JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/LiveAttendance.js"></script>